---
title: "Irrigation Depth in the RRCA"
author: "Jill Deines"
date: "October 15, 2017"
output:
  html_document:
    toc: yes
---

Goal: Model linear trends in irrigation depth over time in the RRCA

```{r knitrOpts, echo=FALSE}
library(knitr)
opts_chunk$set(cache=FALSE, 
               fig.path='figure/9.0_rrcaDepth/')
```

**R Packages Needed**

```{r packages, message=FALSE, echo=TRUE}
library(rgdal)
library(raster)
library(tidyverse)
```

## Make RRCA polygon grid
Extract polygon grids of a few resolutions for the RRCA model

* native: 1 mile resolution
* aggregated: 2 mile, 4 mile


```{r rrcaPolygrids, eval=FALSE}
outRas <- 'S:/Users/deinesji/HPA/gis/Wells/PumpingByGridCell/modelGridRasters'

# load a buffered RRCA boundary
buffer <- readOGR('S:/Users/deinesji/HPA/gis/lhm','RRB_bound2_6500m',verbose=F)

# create template raster grid based on RRCA model grid (165 rows, 326 columns)    
CRS <- '+proj=utm +zone=14 +ellps=clrk66 +datum=NAD27 +units=us-ft +no_defs'
template <- raster(crs=CRS, nrows = 165, ncols=326, resolution = 5280,
                 ymn = 14092806, ymx = 14964006, 
                 xmn = 266023, xmx = 1987023)
template[] <- 1:53790 

# mask with boundary 
buffer.utm <- spTransform(buffer, crs(CRS))
ras1mile <- mask(template, buffer.utm)
writeRaster(ras1mile, paste0(outRas,'/rrca_1mile_buffMasked.tif'))
plot(ras1mile, main = 'default 1 mile grid')

# aggregate to 2 and 4mile, assigning lowest cell number in new region
ras2mile <- aggregate(ras1mile, fact = 2, fun = min, expand=FALSE)
ras4mile <- aggregate(ras2mile, fact = 2, fun = min, expand=FALSE)
plot(ras4mile, main = '4 mile grid')

# convert to polygons and write out
poly1mile <- rasterToPolygons(ras1mile)
poly2mile <- rasterToPolygons(ras2mile)
poly4mile <- rasterToPolygons(ras4mile)
plot(poly4mile, main = '4 mile poly grid')

outPolyDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/kml/FINAL_BOUNDARIES'

# writeOGR(poly1mile, outPolyDir, 'RRCA_polygrid_1mile', driver = 'ESRI Shapefile')
# writeOGR(poly2mile, outPolyDir, 'RRCA_polygrid_2mile', driver = 'ESRI Shapefile')
# writeOGR(poly4mile, outPolyDir, 'RRCA_polygrid_4mile', driver = 'ESRI Shapefile')
```

## Load Data
Pumping data is from the RRCA groundwater model and associated files obtained by Xiao from the guy who works on the model (Sam?). Processed data copied over from S:\Users\deinesji\HPA\gis\Wells\PumpingByGridCell, 
which was produced with R script 4.3_Pumping_Data.Rmd in the RRB_Rcode R project over
in Jills s drive. see that folder's readme.txt and/or script for data source and notes

### Irrigation data
And make a total water column

```{r loadpumping, warning=FALSE}
# irr water master file
pumpDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/pumping'
pumpFile <- 'RRCA_irrAllByCell_1999-2015_longFormat_gw_sw_co_FIXED_20171017.csv'
irrByCell0 <- read.csv(paste0(pumpDir, '/',pumpFile))

# test for year/node duplicates
test3 <- irrByCell0 %>% filter (year == 2000)
nrow(test3)
sum(duplicated(test3$NODE))

dupes <- test3[duplicated(test3$NODE),]
dupes[dupes$NODE %in% c(6065,6391,6717),]
```

Conclusion - some nodes were duplicated in my creation of this master irrigation file. For instance, for NODE/model cell 6717, the gw_acreft was entered 6 time, the sw was 3x2, and the coirr was also 3x2 but in a different pattern. wtf.

```{r}
# set NAs to 0 (warning is for text field, no problem)
irrByCell0[is.na(irrByCell0)] <- 0

# drop extra columns and calculate total irr
irrByCell <- irrByCell0 %>%
  mutate(totalIrr_m3 = gwirr_m3+swirr_m3+coirr_m3,
         unique2 = paste0(year, '-', NODE)) %>%
  dplyr::select(unique2, NODE, inRRB, state, year, totalIrr_m3) 
```

### Load irrigated area by RRCA cell
irrigated pixel counts tallied via GEE script 04.13_RegionalStats_polygrid_interannual in users/jdeines/default/Production

```{r loadAreas}
cellArea <- 30*30 # m^2

areaDir <-'C:/Users/deinesji/Google Drive/GEE_AIM-RRB/GEE_tableExports/RRB_test5_regional_county_Stats'

# regional areas -----------------------------------------------

# function to read in to a single dataframe
loadStats <- function(fileList){
  datOut = as.data.frame(do.call(rbind, lapply(fileList, function(x) {
              csv1 <- read.csv(paste0(areaDir,'/',x))
              csv1$year <- as.numeric(substr(x, start=1,stop=4))
              return(csv1)
           })))  
  # convert cell count to area
  datOut$irrigated_m2 <- datOut$X1 * cellArea
  datOut$irrigated_km2 <- datOut$irrigated_m2 / 1000000
  return(datOut)
}

# load 1 mile files, dropping dummy row
files1 <- list.files(areaDir, pattern="*_test5_RRCA_POLYGRID_1mile.csv")
area1 = loadStats(files1)[-1,] %>%
  dplyr::select(layer, year, pr_ann, irrigated_m2) %>%
  rename(NODE = layer) %>%
  mutate(unique2 = paste0(year, '-', NODE))
```

## Calculate depth
Match up datasets and calculate depth. I wrote out my generated raster/polygon and confirmed the 'layer' variable (cell number) matched the shapefile for pumping data 'node' column

### 1 mile RRCA grid

```{r depth}
# combine datasets by year + node/layer and calculate depth
depth1 <- irrByCell %>%
  left_join(area1) %>%  # drops polys from buffer, and 2016
  mutate(depth_cm = totalIrr_m3/irrigated_m2 * 100) 

# real quick: how many model cells?
length(unique(depth1$NODE))
nrow(depth1 %>% filter(year == 2000))
test <- depth1 %>% filter(year == 2000)
test[duplicated(test$NODE),]  # seems duplication in irrByCell
test2 <- irrByCell %>% filter(year == 2000)
nrow(test2)

# get depth calculation stats
summary(depth1$depth_cm)

depthFilter <- 

hist(depth1$depth_cm)
```

