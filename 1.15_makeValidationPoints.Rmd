---
title: "Make Validation POints, Full RRB"
author: "Jill Deines"
date: "Saturday, November 12, 2016"
output: 
  html_document:
    toc: yes
---

Goal: Use Koeppengeiger and USDA Ecoregion climate divisions, along with CDL crop layers, to stratify sampled points across the RRB.


```{r knitrOpts, echo=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, cache.path='cache/1.15_sampleRRB/',
               fig.path='figure/1.15_sampleRRB/')
```

**R Packages Needed**

```{r packages, message=FALSE, echo=TRUE}
library(rgdal)
library(raster)
library(maptools)
library(rgeos)
library(dplyr)
```

## Load data

```{r loadData}
# filepaths -----------------------------------------------------
# county shapefile
tigerDir <- 'S:/Data/GIS_Data/Downloaded/TIGER/TIGER2012/COUNTY'
tigerName <- 'tl_2012_us_county'

# aquifer and basin boundaries
gisDir <- 'S:/Users/deinesji/HPA/gis'
rrbName <- 'BigExtent_RRB_RRCA_buff'

# usda ecogreions
ecoDir <- 'S:/Users/deinesji/HPA/data/climate/climateDivisions/USDA_Ecoregions'
ecoName <- 'eco_us'

# koeppen
koepPath <- 'S:/Users/deinesji/HPA/data/climate/climateDivisions/Koeppengeiger/KoeppenGeiger_UScounty.txt'

# read in
counties <- readOGR(tigerDir, tigerName, verbose=F)
rrb <- readOGR(gisDir, rrbName, verbose=F)
ecoregions <- readOGR(ecoDir, ecoName, verbose=F)
koepdata <- read.delim(koepPath)
```


### County Koepengeiger to Koepengeiger regions
Clips the TIGER 2012 county shapefile to area of interest and adds the counties Koeppengeiger code, then dissolves into Koep units

```{r getCounties}
# reproject to wgs84
rrb.ll <- spTransform(rrb, CRS(proj4string(counties)))

# clip counties to the rrb
countyRRB <- raster::intersect(counties,rrb.ll)

# trim dataframe and create 5-digit FIPS
countysub <- countyRRB[,c('STATEFP','COUNTYFP','NAME')]
countysub$STATEFP <- as.character(countysub$STATEFP)
countysub$COUNTYFP <- as.character(countysub$COUNTYFP)
countysub$fips <- paste0(countysub$STATEFP, countysub$COUNTYFP)

# pad the fips codes in koep with a leading zero 
koepdata$fips5 <- sprintf('%05d', koepdata$FIPS)

# trim koep to rrb to get better idea of counties with multiple koep codes
rrbcounties <- unique(countysub$fips)
koepRrb <- koepdata[koepdata$fips5 %in% rrbcounties,]
sum(duplicated(koepRrb$fips5)) # 25 counties with multiple codes

# do any counties have 3 codes?
table(koepRrb$fips5) #nope, 2 is the highest count

# for multiple code counties, keep code with greatest proportion
# since only 2 per county, filter out codes with < 0.5 proportion
koepRrbUnique <- koepRrb[koepRrb$PROP > 0.5,]

# add the koeppengeiger code
countyClim <- merge(countysub, koepRrbUnique, by.x = 'fips', by.y = 'fips5', all.x = T)

# write out to not be dependent on S drive
tempDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/validation/1.15_makeRrbPoints_workspace'
#writeOGR(countyClim, tempDir, 'Koep_county_rrb', driver='ESRI Shapefile')
```

### Dissolve and Merge regions
Moved to Dropbox based files to work without internet...

```{r startLocalLoad}
# basin boundaries
gisDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/kml'
rrb <- readOGR(paste0(gisDir,'/BigExtent_RRB_RRCA_buff.kml'), 'boundExtent', verbose=F)

# usda ecogreions
ecoDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/helper/USDA_Ecoregions'
ecoName <- 'eco_us'
ecoregions <- readOGR(ecoDir, ecoName, verbose=F)

# Koepen counties
tempDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/validation/1.15_makeRrbPoints_workspace'
countyClim <- readOGR(tempDir, 'Koep_county_rrb', verbose=F)

# Dissolve koepen counties
koepRrb1 <- unionSpatialPolygons(countyClim, countyClim$CLS)
row.names(koepRrb1) <- as.character(1:length(koepRrb1))
koepData <- data.frame(koep = c('BSk','Cfa','Dfa'))
koepRrb <- SpatialPolygonsDataFrame(koepRrb1, koepData)

spplot(koepRrb, main = 'Koeppengeiger counties in the RRB')

# work in WGS84 latlong
koepRrb <- spTransform(koepRrb, CRS("+proj=longlat +datum=WGS84"))
rrb <- spTransform(rrb, CRS("+proj=longlat +datum=WGS84"))
ecoregions <- spTransform(ecoregions, CRS("+proj=longlat +datum=WGS84"))

# USDA Eco Regions in the RRB
ecoRrb <- raster::intersect(ecoregions, rrb)
# dissolve by province
ecoRrb$PROVINCE <- as.character(ecoRrb$PROVINCE)
eco1 <- unionSpatialPolygons(ecoRrb, ecoRrb$PROVINCE)
row.names(eco1) <- as.character(1:length(eco1))
ecoData <- data.frame(ProvinceShort = c('Dry Steppe','Steppe','Prairie'),
                      Province = c(ecoRrb$PROVINCE[2],
                                   ecoRrb$PROVINCE[1],
                                   ecoRrb$PROVINCE[5]))
ecoRrb2 <- SpatialPolygonsDataFrame(eco1, ecoData)

# intersect the two
#climDivsRrb <- raster::intersect(ecoRrb2, koepRrb)

# write out Koeppengieger
#writeOGR(koepRrb, tempDir, "Koep_RRB_dissolve", driver='ESRI Shapefile')
```

Intersecting the two failed due to orphaned holes in the Ecoregion file. I've decided that the Koeppengeiger divisions will be sufficient.

## Make Stratefied samples
Using the Koeppengieger RRb Shapefile and the CDL raster

```{r makeCDLRRB, eval=FALSE}
# Koepen counties
tempDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/validation/1.15_makeRrbPoints_workspace'
koep <- readOGR(tempDir, 'Koep_RRB_dissolve', verbose=F)


#cdl and key
cdl <- raster('S:/Users/deinesji/HPA/gis/CDL/fullHPA/CDL_2010_HPA_RRB.tif')
#cdl <- raster('S:/Users/deinesji/HPA/gis/CDL/CDL_RRB_2007_adj.tif')
cdlKey <- read.csv('S:/Users/deinesji/HPA/gis/CDL/CDL_key_2014.csv', 
                   stringsAsFactors=F)

# projection datum not read in for cdl, fix 
tweakProj <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"
proj4string(cdl) <- tweakProj

# reproject koeppen
koep <- spTransform(koep, CRS(tweakProj))

# I will process by koep divisions, so mask and export a CDL for each division
for(i in 1:nrow(koep)){
  cdl.clip <- crop(cdl, koep[i,])
  cdl.mask  <- mask(cdl, koep[i,], filename=paste0(tempDir, '/RRB_',
                                                   koep@data[i,1],'.tif'),
                    dataType = 'INT1U')
}
```


```{r makePointsRRB}
# Koepen 
tempDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/validation/1.15_makeRrbPoints_workspace'
koep <- readOGR(tempDir, 'Koep_RRB_dissolve', verbose=F)

# get relative area of koeppen areas
# projection datum not read in for cdl, fix 
tweakProj <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"
# reproject koeppen
koep <- spTransform(koep, CRS(tweakProj))

koep$area <- gArea(koep)

# subtract area of MidRep NRD?
gisDir <- 'C:/Users/deinesji/Dropbox/1PhdJill/hpa/irrigation/data/GIS/kml'
midRep <- readOGR(paste0(gisDir,'NRD_MidRepub/.kml'), 'boundExtent', verbose=F)
midRep <- spTransform(midRep, CRS(tweakProj))
midRep$area <- gArea(midRep)

```

