---
title: 'NASS irrigation: 2010'
author: "Jill Deines"
date: "Monday, June 20, 2016"
output: 
  html_document:
    toc: yes
---

Goal: Access USDA NASS Ag Census Data through the Quick Stats API, and identify all crops irrigated within boundaries for my remote sensing study.


```{r knitrOpts, echo=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, cache.path='cache/4.1_NASS/',
               fig.path='figure/4.1_NASS/')
```

**R Packages Needed**

* `httr`: Vignette at https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html

```{r packages, message=FALSE, echo=TRUE}
# for API interaction
library(httr) 
library(jsonlite)
# for county selection:
library(rgdal)
library(rgeos)
library(maps)
# for data manipulation
library(tidyr)
library(ggplot2)
```

## Functions: NASS Quick Stats API 
This script builds on work in 4.1_USDA_NASS.Rmd in the RRB_Rcode r project.

* API website: http://quickstats.nass.usda.gov/api
* My API key: 28EAA9E6-8060-34A4-981A-B2ED4692228A

Here, I'll make functions to ID counties of interest and pull NASS data from the API, and apply it over the counties.

### Function: Get Counties of Interest
This uses the TIGER county shapefile for the US, extracting counties of interest based on a polygon boundary.

**To do:** deal with counties not entirely inside boundary. 


```{r fun_idCounties}
# # function inputs ------------------------------------
# # load TIGER counties
# countyAll <- readOGR('S:/Data/GIS_Data/Downloaded/TIGER/TIGER2012/COUNTY',
#                      'tl_2012_us_county', verbose=F)
# 
# #polygon denoting area of interest
# gisDir <- 'S:/Users/deinesji/HPA/gis'
# nrds <- readOGR(gisDir,'RRB_NRDs_clip', verbose=F) 
# aoi <- nrds[nrds$NRD_Name == 'Middle Republican',]
# 
# # do a slight negative buffer to avoid line mismatches
# aoi <- gBuffer(aoi, width=-100)
  

# function --------------------------------------------

makeCountyList <- function(countyAll, aoi){
  # match projections
  aoi <- spTransform(aoi, CRS(proj4string(countyAll)))
  
  # id counties inside aoi with a 1. Note `rgeos` must be loaded
  overlap <- gIntersects(countyAll, aoi, byid=T)  # 1's indicate overlap
  
  # remove extra columns and subset overlapping counties
  columnsToKeep <- c('STATEFP','COUNTYFP','COUNTYNS','NAME')
  counties <- countyAll@data[overlap,columnsToKeep]
  
  # fill in state abbrevs column based on FIPS
  data(state.fips)  # from maps package
  state.fips$STATEFP <- sprintf("%02d",state.fips$fips) # add leading zero
  counties <- merge(counties, state.fips[,c('abb','STATEFP')], all.y=F)
  
  return(counties)
}

#test <- makeCountyList(countyAll, aoi)
```

### Function: Extract NASS data by county
This function currently operates at the GROUP level; RRB_Rcode version is at the commodity level (below group); could also do the sector level if desired.

Arguments:

* apiKey: Obtained from http://quickstats.nass.usda.gov/api
* program: 'CENSUS' or 'SURVEY'
* sector: 'CROPS' here (or DEMOGRAPHICS, ECONOMICS, ENVIRONMENTAL, ANIMALS & pRODUCTS)
* group: 'FIELD CROPS' (or HORTICULTURE, VEGETABLES, FRUIT & TREE NUTS)
* aggregation: specify geographic granularity of the data {'STATE','AG DISTRICT','COUNTY','REGION','ZIP CODE'}. Function currently set up for county level only
* state: state 2 character alpha code
* county: county 3-digit ANSI code

```{r fun_getNass}
getNASS <- function(apiKey, program, sector, group, aggregation, state, county){
    # build URL query
  baseurl <- 'http://quickstats.nass.usda.gov/api/api_GET'
  format = 'JSON'
  GETrequest <- paste0(baseurl,
                     '/?key=',apiKey,
                     '&source_desc=',program,
                     '&sector_desc=',sector,
                     '&group_desc=',group,
                     '&agg_level_desc=',aggregation,
                     '&state_alpha=', state,
                     '&county_ansi=', county,
                     '&format=',format)
  
  # if present, replace commas and spaces in url with encodings
  if(grepl(" ", GETrequest))  GETrequest <- gsub(" ", "%20", GETrequest)
  if(grepl(",", GETrequest))  GETrequest <- gsub(",", "%2C", GETrequest)
  
  # retrive data
  req <- GET(GETrequest)
  # check status and throw stop/error: 200 means successful
  stop_for_status(req)
  # extract content
  json <- content(req, as = 'text')
  # convert from JSON and extract df from list object
  outputdf <- fromJSON(json)[[1]]
}

```

### Function: Clean Field Crop Data
Input: A raw NASS data frame for the 'field crop' group and summary year desired

The function cleans the data and aggregates all counties into total commodities for the input region, split by irrigation status. For Hay, it tallies alfalfa hay/haylage as one category, and "other hay" for all other hay/haylages (after removing superset categories).

Returns a sorted data frame with commodity, irrigated area (km^2), non-irrigated area (km^2), and total area (km^2)


```{r fun_nassFieldCropClean}
# # load data
# outdir <- 'S:/Users/deinesji/HPA/data/USDA_NASS'
# outfile <- 'NASS_FieldCrops_County_midRep_RRB_raw.csv'
# nass.df <- read.csv(paste0(outdir, '/', outfile), stringsAsFactors=F)
# 
# year <- 2012

cleanNassCensus <- function(nass.df, year){
  # remove excess columns
  keepThese <- c('state_alpha','prodn_practice_desc','short_desc','Value',
                 'county_name','unit_desc','commodity_desc','year')
  nass.df <- nass.df[,keepThese]
  
  # remove (D) values, remove commas (!), convert to numeric
  nass.df <- nass.df[!grepl('(D)',nass.df$Value),]
  nass.df$Value <- gsub(",", "", nass.df$Value, fixed = T)
  nass.df$Value <- as.numeric(nass.df$Value)
  
  # keep only records with "ACRES HARVESTED"
  phrase <- 'ACRES HARVESTED'
  nass.df <- nass.df[grepl(phrase,nass.df$short_desc),]
  
  # for now, just 2012 (could split into list by year in future..)
  nass.df <- nass.df[nass.df$year == year,]
  
  # aggregate over counties
  commodityTally <- aggregate(Value ~ short_desc, data = nass.df, FUN = 'sum')
  
  # add back in some helpful columns
  mergeTable <- nass.df[,c('commodity_desc','unit_desc',
                           'prodn_practice_desc','short_desc')]
  mergeTable2 <- unique(mergeTable)
  nass.df2 <- merge(commodityTally, mergeTable2, by.x = 'short_desc', all=F,
                    by.y = 'short_desc',sort=F)
  
  # change 'all production practices' to 'total
  nass.df2[nass.df2$prodn_practice_desc == 'ALL PRODUCTION PRACTICES',
           'prodn_practice_desc'] <- 'TOTAL'
  
  # HAY: make an alfalfa category
  alfalfaRecords <- grepl('ALFALFA', nass.df2$short_desc) & 
                      !grepl('EXCL', nass.df2$short_desc)
  nass.df2[alfalfaRecords,'commodity_desc'] <- 'ALFALFA'
  
  # HAY: delete the supersets to leave just "other" classes
  supersets <- c('HAY & HAYLAGE - ACRES HARVESTED',
                 'HAY & HAYLAGE, IRRIGATED - ACRES HARVESTED',
                 'HAY - ACRES HARVESTED',
                 'HAY, IRRIGATED - ACRES HARVESTED',
                 'HAYLAGE - ACRES HARVESTED',
                 'HAYLAGE, IRRIGATED - ACRES HARVESTED')
  
  nass.df3 <- nass.df2[!nass.df2$short_desc %in% supersets,]
  
  # rename HAY and HAYLAGE to TOTAL HAY
  nass.df3[grepl("HAY",nass.df3$commodity_desc),'commodity_desc'] <- 'OTHER HAY'
  nass.df3[grepl("HAYLAGE",nass.df3$commodity_desc),'commodity_desc'] <- 'OTHER HAY'
  
  # aggregate by crop type and irrigation status
  summary <- aggregate(Value ~ commodity_desc + prodn_practice_desc,
                       data = nass.df3, FUN='sum')
  
  # convert from acres to square kilometers
  summary$Value <- summary$Value / 247.105
  
  # fill in a non-irrigated value
  summary.wide <- spread(summary, key = prodn_practice_desc, value = Value)
  summary.wide[is.na(summary.wide$IRRIGATED),'IRRIGATED'] <- 0
  summary.wide$NON_IRR <- summary.wide$TOTAL - summary.wide$IRRIGATED
  
  # sort
  summary.wide <- summary.wide[rev(order(summary.wide$IRRIGATED)),]
  
  return(summary.wide)
}

#test <- cleanNassCensus(nass.df, year)

```


## Get Data!

### Middle Republican NRD

#### ID counties
Get list of counties from shapefile

```{r getcounties}
# load TIGER counties
countyAll <- readOGR('S:/Data/GIS_Data/Downloaded/TIGER/TIGER2012/COUNTY',
                     'tl_2012_us_county', verbose=F)

#polygon denoting area of interest
gisDir <- 'S:/Users/deinesji/HPA/gis'
nrds <- readOGR(gisDir,'RRB_NRDs_clip', verbose=F) 
aoi <- nrds[nrds$NRD_Name == 'Middle Republican',]

# do a slight negative buffer to avoid line mismatches
aoi <- gBuffer(aoi, width=-100)

# get counties in AOI and print 
counties <- makeCountyList(countyAll, aoi)

counties
```

#### download data
Currently downloads all data for the "field crops" group (all years)

```{r getData_midRepNRD, eval=FALSE}
# set up variables for data calls
apiKey <- '28EAA9E6-8060-34A4-981A-B2ED4692228A'
program = 'CENSUS'
sector <- 'CROPS'
group <- 'FIELD CROPS'
aggregation <- 'COUNTY'

# make empty list to populate, and loop through counties
nass.list <- list()
for(i in 1:nrow(counties)){
  nass.list[[i]] <- getNASS(apiKey, program, sector, group, aggregation, 
                              state = counties$abb[i],
                              county = counties$COUNTYFP[i])
}

# convert list of data frames to 1 giant dataframe
nass.df <- do.call("rbind",nass.list)

# write out raw data
outdir <- 'S:/Users/deinesji/HPA/data/USDA_NASS'
outfile <- 'NASS_FieldCrops_County_midRep_RRB_raw.csv'
write.csv(nass.df, paste0(outdir, '/', outfile), row.names=F)
```

#### Clean Data: Get Irrigated Areas
Loading saved data so not reliant on functioning AP. Goal: what crops are irrigated, and in what proportion?

```{r midRep_irrig, fig.height=4, fig.width=8}
# load data
outdir <- 'S:/Users/deinesji/HPA/data/USDA_NASS'
outfile <- 'NASS_FieldCrops_County_midRep_RRB_raw.csv'
nass.df <- read.csv(paste0(outdir, '/', outfile), stringsAsFactors=F)

# clean/summarize data
midRep2012 <- cleanNassCensus(nass.df, year = 2012)

# make  a table
kable(midRep2012[,1:3])

# make a plot of irrigated crops
summary.wide2 <- midRep2012[midRep2012$IRRIGATED > 0,
                              c('commodity_desc','IRRIGATED', 'NON_IRR')]

summary3 <- gather(summary.wide2, key = irrig_type, value = Value,
                   IRRIGATED:NON_IRR)

ggplot(summary3, aes(x=commodity_desc, y=Value, fill=irrig_type)) +
  geom_bar(stat='identity') + 
  ylab('Square Kilometers') + xlab('commodity') + 
  ggtitle('Irrigated Crops - Middle Republican NRD - 2012') + theme_bw()
```
.

"Your request will return a maximum of 50,000 data records. You can determine the returned record account before you execute the Quick Stats API call using the GET /api/get_counts function. If your request will return more than the maximum limit of 50,000 data records, you can do either of the following:"
