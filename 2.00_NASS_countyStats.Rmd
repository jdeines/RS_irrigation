---
title: 'NASS irrigation: 2010'
author: "Jill Deines"
date: "Monday, June 20, 2016"
output: 
  html_document:
    toc: yes
---

Goal: Access USDA NASS Ag Census Data through the Quick Stats API, and identify all crops irrigated within boundaries for my remote sensing study.


```{r knitrOpts, echo=FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, cache.path='cache/4.1_NASS/',
               fig.path='figure/4.1_NASS/')
```

**R Packages Needed**

* `httr`: Vignette at https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html

```{r packages, message=FALSE, echo=TRUE}
# for API interaction
library(httr) 
library(jsonlite)
# for county selection:
library(rgdal)
library(rgeos)
library(maps)
# for data manipulation
library(dplyr)
```

## NASS Quick Stats API
This script builds on work in 4.1_USDA_NASS.Rmd in the RRB_Rcode r project.

* API website: http://quickstats.nass.usda.gov/api
* My API key: 28EAA9E6-8060-34A4-981A-B2ED4692228A

Here, I'll make functions to ID counties of interest and pull NASS data from the API, and apply it over the counties.

## Function: Get Counties of Interest
This uses the TIGER county shapefile for the US, extracting counties of interest based on a polygon boundary.

**To do:** deal with counties not entirely inside boundary. 


```{r fun_idCounties}
# # function inputs ------------------------------------
# # load TIGER counties
# countyAll <- readOGR('S:/Data/GIS_Data/Downloaded/TIGER/TIGER2012/COUNTY',
#                      'tl_2012_us_county', verbose=F)
# 
# #polygon denoting area of interest
# gisDir <- 'S:/Users/deinesji/HPA/gis'
# nrds <- readOGR(gisDir,'RRB_NRDs_clip', verbose=F) 
# aoi <- nrds[nrds$NRD_Name == 'Middle Republican',]
# 
# # do a slight negative buffer to avoid line mismatches
# aoi <- gBuffer(aoi, width=-100)
  

# function --------------------------------------------

makeCountyList <- function(countyAll, aoi){
  # match projections
  aoi <- spTransform(aoi, CRS(proj4string(countyAll)))
  
  # id counties inside aoi with a 1. Note `rgeos` must be loaded
  overlap <- gIntersects(countyAll, aoi, byid=T)  # 1's indicate overlap
  
  # remove extra columns and subset overlapping counties
  columnsToKeep <- c('STATEFP','COUNTYFP','COUNTYNS','NAME')
  counties <- countyAll@data[overlap,columnsToKeep]
  
  # fill in state abbrevs column based on FIPS
  data(state.fips)  # from maps package
  state.fips$STATEFP <- sprintf("%02d",state.fips$fips) # add leading zero
  counties <- merge(counties, state.fips[,c('abb','STATEFP')], all.y=F)
  
  return(counties)
}

#test <- makeCountyList(countyAll, aoi)
```

## Function: Extract NASS data by county
This function currently operates at the GROUP level; RRB_Rcode version is at the commodity level (below group); could also do the sector level if desired.

Arguments:

* apiKey: Obtained from http://quickstats.nass.usda.gov/api
* program: 'CENSUS' or 'SURVEY'
* sector: 'CROPS' here (or DEMOGRAPHICS, ECONOMICS, ENVIRONMENTAL, ANIMALS & pRODUCTS)
* group: 'FIELD CROPS' (or HORTICULTURE, VEGETABLES, FRUIT & TREE NUTS)
* aggregation: specify geographic granularity of the data {'STATE','AG DISTRICT','COUNTY','REGION','ZIP CODE'}. Function currently set up for county level only
* state: state 2 character alpha code
* county: county 3-digit ANSI code

```{r fun_getNass}
getNASS <- function(apiKey, program, sector, group, aggregation, state, county){
    # build URL query
  baseurl <- 'http://quickstats.nass.usda.gov/api/api_GET'
  format = 'JSON'
  GETrequest <- paste0(baseurl,
                     '/?key=',apiKey,
                     '&source_desc=',program,
                     '&sector_desc=',sector,
                     '&group_desc=',group,
                     '&agg_level_desc=',aggregation,
                     '&state_alpha=', state,
                     '&county_ansi=', county,
                     '&format=',format)
  
  # if present, replace commas and spaces in url with encodings
  if(grepl(" ", GETrequest))  GETrequest <- gsub(" ", "%20", GETrequest)
  if(grepl(",", GETrequest))  GETrequest <- gsub(",", "%2C", GETrequest)
  
  # retrive data
  req <- GET(GETrequest)
  # check status and throw stop/error: 200 means successful
  stop_for_status(req)
  # extract content
  json <- content(req, as = 'text')
  # convert from JSON and extract df from list object
  outputdf <- fromJSON(json)[[1]]
}

```

## Get Data!

### ID counties in area

```{r getcounties}
# load TIGER counties
countyAll <- readOGR('S:/Data/GIS_Data/Downloaded/TIGER/TIGER2012/COUNTY',
                     'tl_2012_us_county', verbose=F)

#polygon denoting area of interest
gisDir <- 'S:/Users/deinesji/HPA/gis'
nrds <- readOGR(gisDir,'RRB_NRDs_clip', verbose=F) 
aoi <- nrds[nrds$NRD_Name == 'Middle Republican',]

# do a slight negative buffer to avoid line mismatches
aoi <- gBuffer(aoi, width=-100)

# get counties in AOI and print 
counties <- makeCountyList(countyAll, aoi)

counties
```

### download data
Currently downloads all data for the "field crops" group (all years)

#### middle republican NRD, NE

```{r getData_midRepNRD, eval=FALSE}
# set up variables for data calls
apiKey <- '28EAA9E6-8060-34A4-981A-B2ED4692228A'
program = 'CENSUS'
sector <- 'CROPS'
group <- 'FIELD CROPS'
aggregation <- 'COUNTY'

# make empty list to populate, and loop through counties
nass.list <- list()
for(i in 1:nrow(counties)){
  nass.list[[i]] <- getNASS(apiKey, program, sector, group, aggregation, 
                              state = counties$abb[i],
                              county = counties$COUNTYFP[i])
}

# convert list of data frames to 1 giant dataframe
nass.df <- do.call("rbind",nass.list)

# write out raw data
outdir <- 'S:/Users/deinesji/HPA/data/USDA_NASS'
outfile <- 'NASS_FieldCrops_County_midRep_RRB_raw.csv'
write.csv(nass.df, paste0(outdir, '/', outfile), row.names=F)
```

## Clean Data

### Middle Republican NRD
Loading saved data so not reliant on functioning AP

#### Irrigated crops
First question: what crops are irrigated??

```{r midRep_irrig}
# load data
outdir <- 'S:/Users/deinesji/HPA/data/USDA_NASS'
outfile <- 'NASS_FieldCrops_County_midRep_RRB_raw.csv'
nass.df <- read.csv(paste0(outdir, '/', outfile), stringsAsFactors=F)

# remove excess columns
keepThese <- c('state_alpha','prodn_practice_desc','short_desc','Value',
               'county_name','unit_desc','commodity_desc','year')
nass.df <- nass.df[,keepThese]

# remove (D) values, remove commas (!), convert to numeric
nass.df <- nass.df[!grepl('(D)',nass.df$Value),]
nass.df$Value <- gsub(",", "", nass.df$Value, fixed = T)
nass.df$Value <- as.numeric(nass.df$Value)

# keep only records with "ACRES HARVESTED"
phrase <- 'ACRES HARVESTED'
nass.df <- nass.df[grepl(phrase,nass.df$short_desc),]

# for now, just 2012 (could split into list by year in future..)
nass.df <- nass.df[nass.df$year == 2012,]

# aggregate over counties
commodityTally <- aggregate(Value ~ short_desc, data = nass.df, FUN = 'sum')

# add back in some helpful columns
mergeTable <- nass.df[,c('commodity_desc','unit_desc',
                         'prodn_practice_desc','short_desc')]
mergeTable2 <- unique(mergeTable)
nass.df2 <- merge(commodityTally, mergeTable2, by.x = 'short_desc', all=F,
                  by.y = 'short_desc',sort=F)

# aggregate by crop type and irrigation status
summary <- aggregate(Value ~ commodity_desc + prodn_practice_desc,
                     data = nass.df2, FUN='sum')
summary
```

